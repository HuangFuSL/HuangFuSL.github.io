# 魔术方法

本文主要涵盖Python对象中的魔术方法。魔术方法是类对象中的一种特殊方法，这些方法拥有固定的参数列表和特殊的调用时机。

魔术方法以双下划线`__`开头，以双下划线结尾。

Python中的运算符重载通过魔术方法实现，因此可以将魔术方法分为与运算符无关的特殊方法及与运算符有关的特殊方法

## 与运算符无关的魔术方法

涉及到字符串与字节序列的魔术方法：

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__repr__`|`self`|当调用`repr()`函数时|`str`|返回值应为重建该对象的Python表达式（如果可能），或包含其他信息的字符串`<...>`|
|`__str__`|`self`|当调用`str()`函数时|`str`|调用`print()`等其他函数时会隐式调用`__str__()`，当不存在`__str__()`时会自动调用`__repr__()`|
|`__format__`|`self, format_spec`|当调用`format()`函数时|`str`|`object.__format__(x, '')`等价于`str(x)`|
|`__bytes__`|`self`|当调用`bytes()`函数时|`bytes`|返回值是对象的字节表示|

涉及到数值类型转换的魔术方法：

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__bool__`|`self`|调用`bool()`函数时|`bool`|当`__bool__`函数没有定义时，会隐式调用`__len__`，如果`__len__`也没有定义，则返回`True`|
|`__complex__`|`self`|调用`commplex()`函数时|`complex`|
|`__int__`|`self`|调用`int()`函数时|`int`|
|`__float__`|`self`|调用`float()`函数时|`float`|
|`__hash__`|`self`|调用`hash()`|函数时|`hash()`函数将`__hash__()`的返回值截断到`Py_ssize_t`的范围内，64位系统下`Py_ssize_t`为8字节；`set`等类型的操作也会调用对象的`__hash__`函数|
|`__index__`|`self`|调用`operator.index()`或Python需要整数值时|`int`|当`__int__`、`__float__`、`__complex__`没有实现时，这些函数隐式地调用`__index__`|

集合相关操作

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__len__`|`self`|调用`len()`函数时|`int`|返回值必须为非负整数，在CPython中返回值不能超过`sys.maxsize`中定义的值，否则`len()`等函数会抛出`OverflowError`等异常|
|`__getitemm__`|`self, key`|使用`[]`运算符时（右值）||`key`可以为合法的数组下标，也可以是反向的下标，也可以是序列的切片，该函数应在`key`类型不对应时抛出`TypeError`，`key`超出范围时抛出`IndexError`或`KeyError`（对于映射类型）|
|`__setitem__`|`self, key, value`|使用`[]`运算符时（左值）|`None`|`key`参数的取值及异常处理与`__getitem__`函数相同|
|`__delitem__`|`self, key`|使用`del`删除序列中的元素时|`None`|对于不可删除的序列或映射，无需实现该函数，其他同`__getitem__`|
|`__contains__`|`self, item`|使用`in`作为运算符时|`bool`|对于映射类型，`__contains__`接收的`item`参数对应映射的`key`部分而不是`value`部分。若没有定义该函数，Python首先通过`__iter__`进行查找，其次使用`__getitem__`进行查找|

迭代器与枚举类型

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__iter__`|`self`|调用`iter()`函数或使用循环时||返回值应为可迭代对象，对于可迭代对象，`__iter__`函数返回自身|
|`__reversed__`|`self`|调用`reversed()`函数时||返回值应为可迭代对象，且是原序列的逆序|
|`__next__`|`self`|调用`next()`函数时||返回可迭代对象中的下一个元素，当到达最后一个元素时抛出`StopIteration`|

函数调用

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__call__`|`self, *args, **kwargs`|当对象以函数的方式被调用时||定义了`__call__`方法的对象属于`typing.Callable`类型|

上下文管理（`with`）关键词：

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__enter__`|`self`|使用`with`关键词声明上下文时|`Any`|返回值分配给`as`关键词指明的对象|
|`__exit__`|`self, exc_type, exc_value, traceback`|离开`with`块时|`Any`|若`with`块执行过程中没有出现异常，则`exc_type, exc_value, traceback`参数均为`None`，否则`exit`块可以对异常进行处理|

对象管理

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__new__`|`cls[, ...]`|创建类实例时|`Any`|`__new__`为静态方法且先于`__init__`执行，`__new__`的其余参数会传递给`__init__`。若`__new__`返回的类型与创建的类型不对应，则不会执行`__init__`|
|`__init__`|`self, ...`|初始化类实例时|`None`|若基类定义了`__init__`，则在子类的`__init__`中必须有`super().__init()`的显式调用|
|`__del__`|`self`|对象销毁时|`None`|当对象的引用计数减为0时，对象才可能被删除|

属性管理

|方法名|参数列表|调用时机|返回值类型|备注|
|:-:|:-:|:-:|:-:|:-:|
|`__getattribute__`|`self, name`|使用`self.name`访问对象的属性时|`Any`|为避免无限递归，子类的`__getattribute__`方法的实现中必须包含父类的`__getattribute__`方法调用|
|`__getattr__`|`self, name`|使用`self.name`访问对象的不存在属性或`__getattribute__`函数抛出`AttributeError`异常|`Any`|当`__getattribute__`正常执行时`__getattr__`不会执行|
|`__setattr__`|`self, name, value`|使用`self.name`设置属性的值时|`None`|当试图通过`__setattr__`向对象设置属性值时必须通过类型的`__setattr__`方法进行设置|
|`__delattr__`|`self, name`|执行`del self.name`时|`None`|仅当`del self.name`语句有意义时，才需要实现该方法|
|`__dir__`|`self`|执行`dir()`函数时|`Sequence`|`dir()`会自动进行排序处理|

## 与运算符有关的魔术方法

一元运算符

|描述|方法名|运算符|
|:-:|:-:|:-:|
|取负|`__neg__`|`-`|
|取正|`__pos__`|`+`|
|绝对值|`__abs__`|`abs()`|

比较运算符

|描述|方法名|运算符|
|:-:|:-:|:-:|
|小于|`__lt__`|`<`|
|小于等于|`__le__`|`<=`|
|等于|`__eq__`|`==`|
|不等于|`__ne__`|`!=`|
|大于|`__gt__`|`>`|
|大于等于|`__ge__`|`>=`|

算术运算符

|描述|方法名|运算符|
|:-:|:-:|:-:|
|相加|`__add__`|`+`|
|相减|`__sub__`|`-`|
|相乘|`__mul__`|`*`|
|实数除|`__truediv__`|`/`|
|整数除|`__floordiv__`|`//`|
|取余|`__mod__`|`%`|
|整数除+取余|`__divmod__`|`divmod()`|
|乘方|`__pow__`|`**`|
|取整|`__round__`|`round()`|

反向算术运算符在方法名前面加`r`，如`__radd__`。增量赋值算术运算符在方法名前面加`i`，如`__iadd__`。

位运算符

|描述|方法名|运算符|
|:-:|:-:|:-:|
|按位取反|`__invert__`|`~`|
|左移|`__lshift__`|`<<`|
|右移|`__rshift__`|`>>`|
|按位与|`__and__`|`&`|
|按位或|`__or__`|`|`|
|按位异或|`__xor__`|`^`|

反向算术运算符在方法名前面加`r`，增量赋值算术运算符在方法名前面加`i`。